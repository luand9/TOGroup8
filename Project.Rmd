---
title: 'Final Group Project'
author: "Group 88888"
date: "12/2/2021"
output:
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide 
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data cleaning and importing
```{r}
library(leaflet)
library(dplyr)
citi <- read.csv("citicleaned.csv")
str(citi)
```

```{r}
#Merging Datasets
weather <- read.csv("NYCWeather2019.csv")
weather$STATION <- NULL
weather$NAME <- NULL
weather$DATE <- as.Date(weather$DATE, format= "%m/%d/%Y")
weather$TAVG <- (weather$TMAX + weather$TMIN)/2
str(weather)
```

# Data Visualization

## Historical patterns

### The percentage of trips in each day

```{r}
library(ggplot2)
library(lubridate)
citi$numWeekday <- wday(citi$starttime, label=TRUE)
ggplot(citi) + geom_bar(aes(x=numWeekday, y=(..count..)/sum(..count..)), fill="lavender") + theme_bw() + xlab("Day") + ylab("Percentage")
```

This bar chart shows the percentage of trips across the week. The largest percentage of trips are taken on Wednesday and Friday, while there is a lighter use on Saturday and Sunday.

### The number of trips in each hour by speed
```{r}
library(dplyr)
library(ggplot2)
citi %>%
  group_by(starthour) %>%
  summarize(count = n(),
            dist = mean(distmeters, na.rm = TRUE),
            dur = mean(tripduration, na.rm = TRUE),
            speed = dist/dur) %>%
  ggplot(aes(x=starthour, y = count, fill = speed)) + geom_col()
```

This bar chart shows the number of trips across 24 hours. People mostly ride citi bike during 9 am and 7 pm, which can be explained by rush hours in weekdays. The average speeds from 7 to 9 am are the highest as people hurry to work. The average speeds from 1 to 3 pm are generally lower, indicating people may ride for leisure during afternoon.

### The number of trips in each month by speed
```{r}
citi %>%
  group_by(month) %>%
  summarize(count = n(),
            dist = mean(distmeters, na.rm = TRUE),
            dur = mean(tripduration, na.rm = TRUE),
            speed = dist/dur) %>%
  ggplot(aes(x=month, y = count, fill = speed)) + geom_col()
```
This bar chart shows the number of trips across 12 months. Most trips happen from July to October, while citi bikes are least used during December to February. The highest average speed occurs in February and November, and the lowest in December. 【? Such pattern can be explained by weather. In summer when the weather is fine and the temperature is favorable, people are more likely to ride citi bikes. In cold winter, people tend to choose other transportation methods than citi bikes.】

## Stations

## Map of deficits in each station
```{r}
library(leaflet)

bike_departures <- group_by(citi, station = `start.station.id`, latitude = `start.station.latitude`, longitude = `start.station.longitude`)

departure <- summarise(bike_departures, departure_count = n())

bike_arrivals <- group_by(citi, station = `end.station.id`, latitude = `end.station.latitude`, longitude = `end.station.longitude`)
arrival <- summarise(bike_arrivals, arrival_count = n())

#merge departure and arrival data into one df
bike_deficit <- merge(departure, arrival, all = TRUE)

bike_deficit[is.na(bike_deficit)] <- 0

bike_deficit$deficit <- bike_deficit$departure_count - bike_deficit$arrival_count

leaflet(bike_deficit) %>% 
  addTiles() %>%
  setView(-74, 40.75, zoom = 11.5) %>%
  addCircleMarkers(lng = bike_deficit$longitude, lat = bike_deficit$latitude, 
                   popup = paste(bike_deficit$station, "<br>", ifelse(bike_deficit$deficit>=0, "Bike deficit = ", "Bike surplus = "), 
                                abs(bike_deficit$deficit)), 
                   radius = abs(bike_deficit$deficit)/5, color = ifelse(bike_deficit$deficit>0, "red", "green"))
```

This map shows the deficit/surplus each station has.

```{r}
summary(bike_deficit)
```


```{r}
bike_deficit10percent<-sort(abs(bike_deficit$deficit),decreasing = TRUE)
minimum<-bike_deficit10percent[length(bike_deficit10percent)%/%90]

bike_deficit_worststations<-bike_deficit[abs(bike_deficit$deficit)>=minimum,]

ggplot(data=bike_deficit_worststations, aes(x=bike_deficit_worststations$station, y=abs(bike_deficit_worststations$deficit))) + ggtitle("Bar Chart of Station Deficits in 2019 in NYC")
```

